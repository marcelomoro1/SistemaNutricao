<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Criar Ingrediente - Sistema de Nutri√ß√£o</title>
  <link rel="stylesheet" href="/css/CriarIngrediente.css">
  <link rel="stylesheet" href="/css/navbar.css">
</head>
<body>

<header class="header">
  <div class="logo-container">
    <img src="/images/logo.png" alt="Logo Nutri√ß√£o" class="logo">
    <h1>Sistema de Nutri√ß√£o</h1>
  </div>
  <button type="button" class="navbar-btn" onclick="window.location.href='/criarFichaTecnica'">Voltar</button>
</header>

<div class="container">
  <span class="titulo-formulario">Criar Novo Ingrediente</span>

  <form id="ingredienteForm" th:action="@{/ingredientes/criar}" method="post">
    <section class="section">
      <h2 class="section-title">üìù Informa√ß√µes B√°sicas</h2>
      <div class="section-content">
        <div class="form-row">
          <div class="form-group">
            <label for="nome">Nome do Ingrediente:</label>
            <input type="text" id="nome" name="nome" required placeholder="Ex: Frango, Arroz, Batata...">
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <h2 class="section-title">üçé Informa√ß√µes Nutricionais (por 100g)</h2>
      <div class="section-content">
        <div class="grid-4">
          <div class="form-group">
            <label for="proteina">Prote√≠na (g):</label>
            <input type="number" id="proteina" name="proteina" step="0.01" min="0" required placeholder="0.00">
          </div>
          <div class="form-group">
            <label for="carboidrato">Carboidrato (g):</label>
            <input type="number" id="carboidrato" name="carboidrato" step="0.01" min="0" required placeholder="0.00">
          </div>
          <div class="form-group">
            <label for="lipidio">Lip√≠dio (g):</label>
            <input type="number" id="lipidio" name="lipidio" step="0.01" min="0" required placeholder="0.00">
          </div>
          <div class="form-group">
            <label for="sodio">S√≥dio (mg):</label>
            <input type="number" id="sodio" name="sodio" step="0.01" min="0" required placeholder="0.00">
          </div>
          <div class="form-group">
            <label for="gorduraSaturada">Gordura Saturada (g):</label>
            <input type="number" id="gorduraSaturada" name="gorduraSaturada" step="0.01" min="0" required placeholder="0.00">
          </div>
        </div>
      </div>
    </section>
    <section class="section">
      <div class="section-content">
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Criar Ingrediente</button>
          <button type="button" class="btn btn-secondary" onclick="limparFormulario()">Limpar Formul√°rio</button>
        </div>
      </div>
    </section>
  </form>
</div>

<script>
  // **Fun√ß√£o para limpar o formul√°rio**
  function limparFormulario() {
    document.getElementById('ingredienteForm').reset();
  }

  // **Capturar o evento de submit do formul√°rio**
  document.getElementById('ingredienteForm').addEventListener('submit', function(e) {
    e.preventDefault(); // Previne o envio padr√£o do formul√°rio (o que o th:action faria)

    // **Coleta os valores dos campos do formul√°rio**
    const nome = document.getElementById('nome').value.trim();
    const proteina = parseFloat(document.getElementById('proteina').value);
    const carboidrato = parseFloat(document.getElementById('carboidrato').value);
    const lipidio = parseFloat(document.getElementById('lipidio').value);
    const sodio = parseFloat(document.getElementById('sodio').value);
    const gorduraSaturada = parseFloat(document.getElementById('gorduraSaturada').value);

    // **Valida√ß√£o b√°sica no frontend**
    if (nome === '') {
      alert('Por favor, preencha o nome do ingrediente.');
      return;
    }

    // Validar se todos os valores nutricionais s√£o n√∫meros v√°lidos e n√£o negativos
    const camposNumericos = [
      { id: 'proteina', nomeDisplay: 'Prote√≠na' },
      { id: 'carboidrato', nomeDisplay: 'Carboidrato' },
      { id: 'lipidio', nomeDisplay: 'Lip√≠dio' },
      { id: 'sodio', nomeDisplay: 'S√≥dio' },
      { id: 'gorduraSaturada', nomeDisplay: 'Gordura Saturada' }
    ];

    for (const campo of camposNumericos) {
      const valor = document.getElementById(campo.id).value;
      if (valor === '' || isNaN(parseFloat(valor)) || parseFloat(valor) < 0) {
        alert(`Por favor, preencha um valor v√°lido (n√∫mero n√£o negativo) para ${campo.nomeDisplay}.`);
        return;
      }
    }

    // **Obten√ß√£o do username do nutricionista**
    // IMPORTANTE: Em um ambiente real, o username do nutricionista logado deve ser obtido
    // de forma segura, por exemplo, do contexto de seguran√ßa do Spring (se estiver usando Thymeleaf)
    // ou de um token JWT ap√≥s o login.
    // Para fins de demonstra√ß√£o, estou usando um valor fixo.
    // Adapte esta parte conforme sua l√≥gica de autentica√ß√£o.
    const nutricionistaUsername = "nutricionista"; // <<< Substitua pelo username real do nutricionista logado

    // **Prepara o objeto de dados para enviar ao backend**
    const dadosIngrediente = {
      nome: nome,
      proteina: proteina,
      carboidrato: carboidrato,
      lipidio: lipidio,
      sodio: sodio,
      gorduraSaturada: gorduraSaturada,
      // N√£o precisamos enviar id, nutricionistaId, nutricionistaUsername do frontend para a cria√ß√£o,
      // pois eles ser√£o gerados/preenchidos pelo backend.
    };

    // **Faz a requisi√ß√£o POST para o backend usando a Fetch API**
    fetch(`/api/ingredientes/nutricionista/${nutricionistaUsername}`, {
      method: 'POST', // Define o m√©todo HTTP como POST
      headers: {
        'Content-Type': 'application/json', // Indica que o corpo da requisi√ß√£o √© JSON
        // Se voc√™ tiver autentica√ß√£o (ex: JWT), adicione o cabe√ßalho de autoriza√ß√£o aqui:
        // 'Authorization': 'Bearer SEU_TOKEN_DE_AUTENTICACAO_AQUI'
      },
      body: JSON.stringify(dadosIngrediente), // Converte o objeto JavaScript em uma string JSON
    })
            .then(response => {
              // Verifica se a resposta HTTP foi bem-sucedida (status 2xx)
              if (response.ok) {
                return response.json(); // Se sim, parseia a resposta como JSON
              }
              // Se a resposta n√£o foi OK, tenta ler o JSON de erro e lan√ßa uma exce√ß√£o
              return response.json().then(errorData => {
                throw new Error(errorData.message || 'Erro desconhecido ao criar ingrediente.');
              });
            })
            .then(data => {
              // Lida com a resposta de sucesso do backend
              console.log('Ingrediente criado com sucesso:', data);
              alert('Ingrediente criado com sucesso!');
              // Redireciona para outra p√°gina ap√≥s o sucesso
              window.location.replace('/criarFichaTecnica');
            })
            .catch(error => {
              // Lida com erros na requisi√ß√£o ou na resposta
              console.error('Erro ao enviar dados do ingrediente:', error);
              alert('Erro ao criar ingrediente: ' + error.message);
            });
  });
</script>

</body>
</html>